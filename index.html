<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>test</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f4f7f6;
      color: #333;
      padding: 20px;
      display: grid;
      place-items: center;
      min-height: 90vh;
    }

    .container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 25px 30px;
      max-width: 800px;
      width: 100%;
    }

    h2 {
      color: #111;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }

    input[type="file"],
    input[type="text"],
    input[type="number"] {
      font-size: 16px;
      padding: 10px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      display: block;
      width: 95%;
      margin-bottom: 10px;
    }
    
    /* ğŸš¨ textarea ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    textarea {
      font-size: 14px;
      padding: 10px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      display: block;
      width: 95%;
      height: 200px; /* ì ì ˆí•œ ë†’ì´ ì„¤ì • */
      margin-bottom: 10px;
      resize: vertical;
    }

    button {
      font-size: 16px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      margin-top: 10px;
    }

    button:hover {
      background-color: #0056b3;
    }

    #createRisumButton {
      background-color: #28a745;
      display: none;
      /* ë¡œë“œ ì™„ë£Œ ì „ê¹Œì§€ ìˆ¨ê¹€ */
    }

    #createRisumButton:hover {
      background-color: #218838;
    }

    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #555;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body>
  <div class="container">
    <h2>.charx â†’ .risum ë³€í™˜ê¸°</h2>
    <p>.charx íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë‚´ë¶€ ì—ì…‹ì„ ì½ì–´ ìƒˆ .risum íŒŒì¼ë¡œ ë§Œë“­ë‹ˆë‹¤.</p>
    <input type="text" id="charName" placeholder="ìºë¦­í„° ì´ë¦„" />
    <input type="checkbox" id="hasNameToggle" /> ì—ì…‹ì˜ ì²« ë¶€ë¶„ì— ì´ë¦„ ì¡´ì¬í•¨<br />
    <input type="text" id="filterText" placeholder="ğŸ” ì—ì…‹ ì´ë¦„ í•„í„° (ì˜ˆ: 'avatar')" />
    <input type="checkbox" id="hasCostumeToggle" /> ì—ì…‹ì˜ ë‘ë²ˆì§¸ ë¶€ë¶„ì— ë³µì¥ ì¡´ì¬í•¨(ë™ì‘ì•ˆí•¨)<br />
    
    <textarea id="profileInput" placeholder="ì—¬ê¸°ì— ìºë¦­í„° í”„ë¡œí•„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆì‹œ: # Character Profile: ìºë¦­í„° ì´ë¦„...)"></textarea>
    
    <input type="file" id="fileInput" accept=".charx, .zip" />
    <div id="status">.charx íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>

    <button id="createRisumButton">
      New .risum íŒŒì¼ ìƒì„±
    </button>
  </div>

  <script type="module">
    import { encodeRPack } from './rpack_bg.js'; // ìœ„ì¹˜ í™•ì¸ í•„ìš”

    // ì •ê·œì‹ í…œí”Œë¦¿ (ì¬ì‚¬ìš©ì„ ìœ„í•´ ë³µì›)
    const reTemplate = {
      "comment": "",
      "in": "",
      "out": "",
      "type": "",
      "ableFlag": false
    }

    class BinaryWriter {
      parts = []; totalLength = 0;
      writeByte(v) { const a = new Uint8Array([v]); this.parts.push(a); this.totalLength += 1; }
      writeUInt32LE(v) { const b = new ArrayBuffer(4); new DataView(b).setUint32(0, v, true); this.parts.push(new Uint8Array(b)); this.totalLength += 4; }
      writeBytes(d) { this.parts.push(d); this.totalLength += d.length; }
      toUint8Array() { const r = new Uint8Array(this.totalLength); let o = 0; for (const p of this.parts) { r.set(p, o); o += p.length; } return r; }
    }

    const MAGIC_NUMBER = 111, VERSION = 0, ASSET_MARKER = 1, EOF_MARKER = 0;
    const textEncoder = new TextEncoder();

    const fileInput = document.getElementById('fileInput');
    const filterInput = document.getElementById('filterText');
    const statusDiv = document.getElementById('status');
    const createRisumButton = document.getElementById('createRisumButton');
    const hasName = document.getElementById('hasNameToggle');
    const charNameInput = document.getElementById('charName');
    // ğŸš¨ í”„ë¡œí•„ ì…ë ¥ë€ DOM ê°€ì ¸ì˜¤ê¸°
    const profileInput = document.getElementById('profileInput'); 

    filterInput.style.display = hasNameToggle.checked ? 'inline-block' : 'none';
    hasNameToggle.addEventListener('change', () => {
      filterInput.style.display = hasNameToggle.checked ? 'inline-block' : 'none';
    });

    let processedAssetsMap = new Map();
    let originalCardName = "new_module";

    fileInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      statusDiv.textContent = `ğŸ“‚ '${file.name}' ì²˜ë¦¬ ì¤‘...`;
      createRisumButton.style.display = 'none';
      processedAssetsMap.clear();

      try {
        const buffer = await file.arrayBuffer();
        const filterText = filterInput.value.trim();
        const { assetNameMap, cardName } = await makeAssetNameMap(buffer, filterText);
        originalCardName = cardName || "new_module";

        const zip = await JSZip.loadAsync(buffer);
        processedAssetsMap = await loadAssetsIntoMemory(zip, assetNameMap);

        statusDiv.textContent = `âœ… ${processedAssetsMap.size}ê°œ ì—ì…‹ ë¡œë“œ ì™„ë£Œ. .risum ìƒì„± ê°€ëŠ¥`;
        if (processedAssetsMap.size > 0) createRisumButton.style.display = 'block';
        else statusDiv.textContent = "âš ï¸ ì¼ì¹˜í•˜ëŠ” ì—ì…‹ì´ ì—†ìŠµë‹ˆë‹¤.";
      } catch (err) { console.error(err); statusDiv.textContent = "âŒ ì˜¤ë¥˜: " + err.message; }
    });

    createRisumButton.addEventListener('click', async () => {
      if (processedAssetsMap.size === 0) { alert("ë³€í™˜í•  ì—ì…‹ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      statusDiv.textContent = `ğŸ–Šï¸ ${processedAssetsMap.size}ê°œ ì—ì…‹ìœ¼ë¡œ .risum ìƒì„± ì¤‘...`;
      const charName = charNameInput.value.trim();
      // ğŸš¨ í”„ë¡œí•„ í…ìŠ¤íŠ¸ ê°’ ì½ì–´ì˜¤ê¸°
      const profileText = profileInput.value; 

      try {
        const assetsForExport = [], assetsForJson = [];
        const costumeSet = new Set();
        const keywordSet = new Set();
        for (const [fullName, blob] of processedAssetsMap.entries()) {
          const arrayBuffer = await blob.arrayBuffer();
          const uint8Data = new Uint8Array(arrayBuffer);
          assetsForExport.push({ id: fullName, data: uint8Data });

          const extension = fullName.split('.').pop() || "png";

          const nameWithoutExt = fullName.substring(0, fullName.lastIndexOf('.'));
          const replaceName = nameWithoutExt.replace('.', '_')
          const splitNameParts = replaceName.split('_');

          let assetName = charName;
          if (hasName) {
            assetName += '_' + splitNameParts.slice(1).join('_');
          } else {
            assetName += '_' + splitNameParts.join('_');
          }
          const splitAssetName = assetName.split('_')
          // ğŸš¨ ìˆ˜ì •ëœ ë¡œì§: ë°°ì—´ì˜ ê°œë³„ ìš”ì†Œë¥¼ Setì— ì¶”ê°€
          keywordSet.add(...splitAssetName.slice(1)); 

          assetsForJson.push([assetName, "", extension]);
        }

        const newModuleId = crypto.randomUUID();
        // ğŸš¨ í”„ë¡œí•„ í…ìŠ¤íŠ¸ë¥¼ createModuleDataì— ì „ë‹¬
        const moduleData = createModuleData(newModuleId, charName, costumeSet, keywordSet, profileText); 
        moduleData.assets = assetsForJson;

        const fileBytes = await exportRisum(moduleData, assetsForExport);
        triggerDownload(fileBytes, `${charName}.risum`);
        statusDiv.textContent = `âœ… ${charName}.risum ìƒì„± ì™„ë£Œ!`;
      } catch (err) { console.error(err); statusDiv.textContent = "âŒ .risum ìƒì„± ì˜¤ë¥˜: " + err.message; }
    });

    // ... (makeAssetNameMap, loadAssetsIntoMemory í•¨ìˆ˜ëŠ” ë™ì¼) ...
    async function makeAssetNameMap(buffer, filterText = "") {
      let zip;
      try { zip = await JSZip.loadAsync(buffer); } catch { throw new Error("ZIP íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨"); }
      const cardJsonFile = zip.file('card.json');
      if (!cardJsonFile) throw new Error("'card.json' ì—†ìŒ");
      const assetNameMap = new Map();
      const metadata = JSON.parse(await cardJsonFile.async('string'));
      const assetsList = metadata?.data?.assets || [];
      const cardName = metadata?.data?.name || "new_module";
      for (const asset of assetsList) {
        const uri = asset.uri?.split('/').pop();
        const name = asset.name || "";
        if (!uri) continue;
        if (!filterText || name.includes(filterText)) assetNameMap.set(uri, name);
      }
      return { assetNameMap, cardName };
    }

    async function loadAssetsIntoMemory(zip, assetMap) {
      const assetDataMap = new Map();
      for (const [path, file] of Object.entries(zip.files)) {
        const fileName = path.split('/').pop();
        if (assetMap.has(fileName)) {
          const blob = await file.async("blob");
          const assetName = assetMap.get(fileName);
          assetDataMap.set(assetName, blob);
        }
      }
      return assetDataMap;
    }

    // ğŸš¨ createModuleData í•¨ìˆ˜ ì •ì˜ ë³€ê²½: profileText ë§¤ê°œë³€ìˆ˜ ì¶”ê°€
    function createModuleData(id, name, costume, keywords, profileText) {
      // 1. keywords ì•ˆì „ ì²˜ë¦¬ ë° ì •ì œ
      const safeKeywords = keywords || []; 
      const keywordArray = [...new Set(Array.from(safeKeywords))]
          .filter(k => k && typeof k === 'string' && k.trim() !== '') 
          .map(k => k.trim())
          .sort(); 

      const all_keywords = keywordArray.join(', ');

      const example1 = keywordArray[0] || 'smile';
      const example2 = keywordArray[1] || 'angry';
      const wrongExample = keywordArray[0] || 'smile';

      const GNDtemplate = `## [MUST FOLLOW!] ${name} Persona Image Commands (Keyword-Only)\n\n### Rules\n- Analyze ${name}'s current state.\n- Output 2â€“4 image tags per response, each on its own line between paragraphs.\n- Use ONLY keywords from the library below.\n- If a desired keyword is missing, pick the CLOSEST valid one.\n- Format: \`<img cmd="${name}_{{keyword}}">\`\n\n### Keyword Library\n${all_keywords}\n\n### Examples\n* \`<img cmd="${name}_${example1}">\`\n* \`<img cmd="${name}_${example2}">\`\n* WRONG: \`<img cmd="${name}.${wrongExample}">\` (use \_)\n* WRONG: \`<img cmd="${name}_very_happy_2">\` (not in library)`;
      
      const displayRule = { ...reTemplate };
      displayRule.comment = "ìµœì¢… ë””ìŠ¤í”Œë ˆì´"
      displayRule.in = "<img cmd=\"(.+)\">"
      displayRule.out = "<style>\n Â  Â .image-container {\n Â  Â  Â  Â /* --- â–¼ ìŠ¤íƒ€ì¼ ê¸°ë°˜ --- */\n Â  Â  Â  Â margin: auto auto;\n Â  Â  Â  Â background-size: cover;\n Â  Â  Â  Â /* background-position: center 20%; Â <-- ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬ */\n Â  Â  Â  Â background-position: center center; /* <-- ì¶”ê°€ */\n Â  Â  Â  Â border-radius: 20px;\n Â  Â  Â  Â border: 5px solid #EBE0E0;\n Â  Â  Â  Â cursor: pointer;\n Â  Â  Â  Â transition: all 0.6s ease; /* transitionì€ ì´ì œ í•„ìš” ì—†ì§€ë§Œ, ë‚¨ê²¨ë‘¬ë„ ë¬¸ì œëŠ” ì—†ì–´ìš” */\n\n Â  Â  Â  Â /* --- â–¼ ë°˜ì‘í˜• ë„ˆë¹„ ì„¤ì • --- */\n Â  Â  Â  Â {{#if {{? {{screen_width}} > 768 }} }}\n Â  Â  Â  Â  Â width: 20em; /* PCì—ì„œëŠ” ê³ ì • ë„ˆë¹„ */\n Â  Â  Â  Â {{/if}}\n Â  Â  Â  Â {{#if {{? {{screen_width}} <= 768 }} }}\n Â  Â  Â  Â  Â width: 95%; /* ëª¨ë°”ì¼ì—ì„œëŠ” ê½‰ ì°¨ê²Œ */\n Â  Â  Â  Â {{/if}}\n\n Â  Â  Â  Â /* --- â–¼ 'ì ‘íŒ' ìƒíƒœ ì‚­ì œ --- */\n Â  Â  Â  Â /* aspect-ratio: 1 / 1; <-- ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬ */\n\n Â  Â  Â  Â /* --- â–¼ 'í¼ì³ì§„' ìƒíƒœ (ì„¸ë¡œë¡œ ê¸¸ê²Œ) - ê¸°ë³¸ìœ¼ë¡œ ì ìš© --- */\n Â  Â  Â  Â {{#if {{? {{screen_width}} > 768 }} }}\n Â  Â  Â  Â  Â aspect-ratio: 2 / 3; /* PCì—ì„œëŠ” 2:3 ë¹„ìœ¨ë¡œ */\n Â  Â  Â  Â {{/if}}\n Â  Â  Â  Â {{#if {{? {{screen_width}} <= 768 }} }}\n Â  Â  Â  Â  Â aspect-ratio: 1 / 1.5; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì¡°ê¸ˆ ëœ ê¸¸ê²Œ */\n Â  Â  Â  Â {{/if}}\n Â  Â }\n\n Â  Â /* --- â–¼ ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ 'í¼ì³ì§„' ìƒíƒœ --- */\n Â  Â /* .image-container:hover { ... } Â <-- ì´ ì „ì²´ ë¸”ë¡ ì‚­ì œ */\n\n</style>\n<div class=\"image-container\" style=\"background-image: url('{{raw::$1}}')\"></div>"
      displayRule.type = "editdisplay"

      const imageRule = { ...reTemplate };
      // ğŸš¨ ì •ê·œì‹ íŒ¨í„´ ìˆ˜ì •: ê·¸ë£¹ ìº¡ì³ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì ìš©í•©ë‹ˆë‹¤.
      const patternInside = `${name}_(?:${keywordArray.join('|')})`;
      const imgTag = `<img cmd=\"(${patternInside})\">`;
      
      imageRule.comment = "í†µí•© ê·œì¹™"
      // in: name_keyword1 ë˜ëŠ” name_keyword2... ë¥¼ ìº¡ì³í•©ë‹ˆë‹¤.
      imageRule.in = imgTag
      // out: ìº¡ì³ëœ ê·¸ë£¹($1)ì„ img cmdì˜ í‚¤ì›Œë“œë¡œ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
      imageRule.out = "<img cmd=\"$1\">"; 
      imageRule.type = "editoutput"

      // ğŸš¨ ìºë¦­í„° í”„ë¡œí•„ ë¡œì–´ë¶ í•­ëª©
      const profileEntry = {
          "key": "",
          "secondkey": "",
          "insertorder": 100, // ì´ë¯¸ì§€ ê·œì¹™(100)ë³´ë‹¤ ë¨¼ì € ì‚½ì…
          "comment": `ì†Œê°œë¬¸`,
          "content": profileText, // ğŸš¨ í”„ë¡œí•„ í…ìŠ¤íŠ¸ ì‚½ì…
          "mode": "normal",
          "alwaysActive": false,
          "selective": false,
          "extentions": {
            "risu_case_sensitive": false,
            "risu_loreCache": null
          },
          "loreCache": null,
          "useRegex": false,
          "bookVersion": 2
      };

      const GNDEntry = {
        "key": "",
        "secondkey": "",
        "insertorder": 100,
        "comment": "ê¸€ë…¸ë®",
        "content": GNDtemplate,
        "mode": "normal",
        "alwaysActive": true,
        "selective": false,
        "extentions": {
          "risu_case_sensitive": false,
          "risu_loreCache": null
        },
        "loreCache": null,
        "useRegex": false,
        "bookVersion": 2
      };

      const trigger1 ={
      "comment": "",
      "type": "manual",
      "conditions": [],
      "effect": [
        {
          "type": "v2Header",
          "code": "",
          "indent": 0
        }
      ],
      "lowLevelAccess": false
    }
    const trigger2 ={
      "comment": "New Event",
      "type": "manual",
      "conditions": [],
      "effect": [],
      "lowLevelAccess": false
    }

      // 4. ëª¨ë“ˆ ë°˜í™˜
      return {
        name,
        description: name,
        id,
        assets: [],
        namespace: `ns_${id.replace(/-/g,'_').substring(0,10)}`, // í•„ìˆ˜ ì†ì„± ë³µì›
        hideIcon: false,
        customModuleToggle: "", // í•„ìˆ˜ ì†ì„± ë³µì›
        regex: [imageRule,displayRule], // ì´ë¯¸ì§€ ê·œì¹™ê³¼ ë””ìŠ¤í”Œë ˆì´ ê·œì¹™ ì‚½ì…
        lorebook: [profileEntry, GNDEntry], // ğŸš¨ í”„ë¡œí•„ê³¼ GND í•­ëª© ëª¨ë‘ ì‚½ì…
        trigger: [trigger1, trigger2],
        lowLevelAccess: false,
        backgroundEmbedding: "" // í•„ìˆ˜ ì†ì„± ë³µì›
      };
    }

    async function exportRisum(moduleData, assets) {
      const writer = new BinaryWriter();
      const mainDataWrapper = { module: moduleData, type: "risuModule" };
      const mainDataJson = textEncoder.encode(JSON.stringify(mainDataWrapper));
      const compressedMainData = await encodeRPack(mainDataJson);

      writer.writeByte(MAGIC_NUMBER);
      writer.writeByte(VERSION);
      writer.writeUInt32LE(compressedMainData.length);
      writer.writeBytes(compressedMainData);

      for (const asset of assets) {
        const compressedAssetData = await encodeRPack(asset.data);
        writer.writeByte(ASSET_MARKER);
        writer.writeUInt32LE(compressedAssetData.length);
        writer.writeBytes(compressedAssetData);
      }

      writer.writeByte(EOF_MARKER);
      return writer.toUint8Array();
    }

    function triggerDownload(bytes, filename) {
      const blob = new Blob([bytes], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>