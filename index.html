<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f4f7f6;
      color: #333;
      padding: 20px;
      display: grid;
      place-items: center;
      min-height: 90vh;
    }
    .container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 25px 30px;
      max-width: 800px;
      width: 100%;
    }
    h2 {
      color: #111;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    input[type="file"], input[type="text"], input[type="number"] {
      font-size: 16px;
      padding: 10px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      display: block;
      width: 95%;
      margin-bottom: 10px;
    }
    button {
      font-size: 16px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      margin-top: 10px;
    }
    button:hover { background-color: #0056b3; }
    #createRisumButton {
      background-color: #28a745;
      display: none; /* ë¡œë“œ ì™„ë£Œ ì „ê¹Œì§€ ìˆ¨ê¹€ */
    }
    #createRisumButton:hover { background-color: #218838; }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #555;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>.charx â†’ .risum ë³€í™˜ê¸°</h2>
    <p>.charx íŒŒì¼ì„ ì„ íƒí•˜ë©´ ë‚´ë¶€ ì—ì…‹ì„ ì½ì–´ ìƒˆ .risum íŒŒì¼ë¡œ ë§Œë“­ë‹ˆë‹¤.</p>
    <input type="text" id="charName" placeholder="ëª…" />
    <input type="checkbox" id="hasNameToggle"/> ì—ì…‹ì˜ ì²« ë¶€ë¶„ì— ì´ë¦„ ì¡´ì¬í•¨<br/>
    <input type="text" id="filterText" placeholder="ğŸ” ì—ì…‹ ì´ë¦„ í•„í„° (ì˜ˆ: 'avatar')" />
    <input type="checkbox" id="hasCostumeToggle"/> ì—ì…‹ì˜ ë‘ë²ˆì§¸ ë¶€ë¶„ì— ë³µì¥ ì¡´ì¬í•¨<br/>
    <input type="file" id="fileInput" accept=".charx, .zip" />
    <div id="status">.charx íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    
    <button id="createRisumButton">
      New .risum íŒŒì¼ ìƒì„±
    </button>
  </div>

<script type="module">
    import { encodeRPack } from './rpack_bg.js'; // ìœ„ì¹˜ í™•ì¸ í•„ìš”

    class BinaryWriter {
    parts = []; totalLength = 0;
    writeByte(v) { const a = new Uint8Array([v]); this.parts.push(a); this.totalLength += 1; }
    writeUInt32LE(v) { const b = new ArrayBuffer(4); new DataView(b).setUint32(0,v,true); this.parts.push(new Uint8Array(b)); this.totalLength += 4; }
    writeBytes(d) { this.parts.push(d); this.totalLength += d.length; }
    toUint8Array() { const r = new Uint8Array(this.totalLength); let o=0; for(const p of this.parts){r.set(p,o);o+=p.length;} return r; }
    }

    const MAGIC_NUMBER = 111, VERSION = 0, ASSET_MARKER = 1, EOF_MARKER = 0;
    const textEncoder = new TextEncoder();

    const fileInput = document.getElementById('fileInput');
    const filterInput = document.getElementById('filterText');
    const indexInput = document.getElementById('index');
    const statusDiv = document.getElementById('status');
    const createRisumButton = document.getElementById('createRisumButton');
    const risumNameSpan = document.getElementById('risumName');
    const hasName = document.getElementById('hasNameToggle');
    const hasCostume = document.getElementById('hasCostumeToggle');
    const charNameInput = document.getElementById('charName');

    filterInput.style.display = hasNameToggle.checked ? 'inline-block' : 'none';
    hasNameToggle.addEventListener('change', () => {
        filterInput.style.display = hasNameToggle.checked ? 'inline-block' : 'none';
    });

    let processedAssetsMap = new Map();
    let originalCardName = "new_module";

    fileInput.addEventListener('change', async (event)=>{
    const file = event.target.files[0];
    if(!file) return;
    statusDiv.textContent = `ğŸ“‚ '${file.name}' ì²˜ë¦¬ ì¤‘...`;
    createRisumButton.style.display='none';
    processedAssetsMap.clear();

    try{
        const buffer = await file.arrayBuffer();
        const filterText = filterInput.value.trim();
        const { assetNameMap, cardName } = await makeAssetNameMap(buffer, filterText);
        originalCardName = cardName || "new_module";

        const zip = await JSZip.loadAsync(buffer);
        processedAssetsMap = await loadAssetsIntoMemory(zip, assetNameMap);

        statusDiv.textContent = `âœ… ${processedAssetsMap.size}ê°œ ì—ì…‹ ë¡œë“œ ì™„ë£Œ. .risum ìƒì„± ê°€ëŠ¥`;
        if(processedAssetsMap.size>0) createRisumButton.style.display='block';
        else statusDiv.textContent="âš ï¸ ì¼ì¹˜í•˜ëŠ” ì—ì…‹ì´ ì—†ìŠµë‹ˆë‹¤.";
    }catch(err){ console.error(err); statusDiv.textContent="âŒ ì˜¤ë¥˜: "+err.message; }
    });

    createRisumButton.addEventListener('click', async ()=>{
    if(processedAssetsMap.size===0){ alert("ë³€í™˜í•  ì—ì…‹ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    statusDiv.textContent=`ğŸ–Šï¸ ${processedAssetsMap.size}ê°œ ì—ì…‹ìœ¼ë¡œ .risum ìƒì„± ì¤‘...`;
    const charName = charNameInput.value.trim();

    try{
        const assetsForExport=[], assetsForJson=[];
        for(const [fullName, blob] of processedAssetsMap.entries()){
        const arrayBuffer=await blob.arrayBuffer();
        const uint8Data=new Uint8Array(arrayBuffer);
        assetsForExport.push({id: fullName, data:uint8Data});

        const extension=fullName.split('.').pop()||"png";
        
        const nameWithoutExt=fullName.substring(0, fullName.lastIndexOf('.'));
        const replaceName = nameWithoutExt.replace('.', '_')
        const splitNameParts = replaceName.split('_');
        
        let assetName = charName;
        if (hasName) {
            assetName += '_' + splitNameParts.slice(1).join('_'); 
        } else {
            assetName += '_' + splitNameParts.join('_');
        }

        assetsForJson.push([assetName,"",extension]);
        }

        const newModuleId=crypto.randomUUID();
        const moduleData=createModuleData(newModuleId, charName);
        moduleData.assets=assetsForJson;

        const fileBytes=await exportRisum(moduleData, assetsForExport);
        triggerDownload(fileBytes, `${charName}.risum`);
        statusDiv.textContent=`âœ… ${charName}.risum ìƒì„± ì™„ë£Œ!`;
    }catch(err){ console.error(err); statusDiv.textContent="âŒ .risum ìƒì„± ì˜¤ë¥˜: "+err.message; }
    });

    async function makeAssetNameMap(buffer, filterText=""){
    let zip;
    try{ zip=await JSZip.loadAsync(buffer); } catch{ throw new Error("ZIP íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨"); }
    const cardJsonFile=zip.file('card.json');
    if(!cardJsonFile) throw new Error("'card.json' ì—†ìŒ");
    const assetNameMap=new Map();
    const metadata=JSON.parse(await cardJsonFile.async('string'));
    const assetsList=metadata?.data?.assets||[];
    const cardName=metadata?.data?.name||"new_module";
    for(const asset of assetsList){
        const uri=asset.uri?.split('/').pop();
        const name=asset.name||"";
        if(!uri) continue;
        if(!filterText || name.includes(filterText)) assetNameMap.set(uri,name);
    }
    return { assetNameMap, cardName };
    }

    async function loadAssetsIntoMemory(zip, assetMap){
    const assetDataMap=new Map();
    for(const [path,file] of Object.entries(zip.files)){
        const fileName=path.split('/').pop();
        if(assetMap.has(fileName)){
        const blob=await file.async("blob");
        const assetName=assetMap.get(fileName);
        assetDataMap.set(assetName,blob);
        }
    }
    return assetDataMap;
    }

    function createModuleData(id,name){
    return { name, description:"charx ë³€í™˜ ëª¨ë“ˆ", id, assets:[], namespace:`ns_${id.replace(/-/g,'_').substring(0,10)}`, hideIcon:false, customModuleToggle:"", regex:[], lorebook:[], trigger:[], lowLevelAccess:false, backgroundEmbedding:"" };
    }

    async function exportRisum(moduleData, assets){
    const writer=new BinaryWriter();
    const mainDataWrapper={module:moduleData,type:"risuModule"};
    const mainDataJson=textEncoder.encode(JSON.stringify(mainDataWrapper));
    const compressedMainData=await encodeRPack(mainDataJson);

    writer.writeByte(MAGIC_NUMBER);
    writer.writeByte(VERSION);
    writer.writeUInt32LE(compressedMainData.length);
    writer.writeBytes(compressedMainData);

    for(const asset of assets){
        const compressedAssetData=await encodeRPack(asset.data);
        writer.writeByte(ASSET_MARKER);
        writer.writeUInt32LE(compressedAssetData.length);
        writer.writeBytes(compressedAssetData);
    }

    writer.writeByte(EOF_MARKER);
    return writer.toUint8Array();
    }

    function triggerDownload(bytes, filename){
    const blob=new Blob([bytes],{type:'application/octet-stream'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    }
    </script>
</body>
</html>
